# Configuration file for Travis CI builds,
# which are automatically run when code is pushed to Github.
# To skip a build, add [ci skip] to the commit message.
# This file has been linted using: http://lint.travis-ci.org/

# Use PHP, to run unit tests
language: php

# PHP versions to test against
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
php:
  - 5.6.30 # MAMP
#  - 5.5 # Sitehost - fails phpunit version requirement

# Public Environment Variables
# https://docs.travis-ci.com/user/environment-variables
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
env:
  - WP_VERSION=latest WP_MULTISITE=0

# Build Matrix
# consisting of specific runtime/env/exclude/include combinations.
# Each 'include' is run as a separate job.
# https://docs.travis-ci.com/user/customizing-the-build/#Build-Matrix
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
matrix:
  # reduce the delay in the build status being reported
  # https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
  fast_finish: true
  include:
    - php: 5.6.30
      env: WP_VERSION=latest WP_MULTISITE=0

# Cache directories between builds, to store dependencies
# which take longer to compile or download.
# https://docs.travis-ci.com/user/caching#Caching-directories-(Bundler%2C-dependencies)
# https://github.com/wp-cli/sample-plugin/blob/master/.travis.yml
# https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
# ~/files - https://blog.wyrihaximus.net/2015/07/composer-cache-on-travis/
cache:
  directories:
#   - node_modules
#   - vendor
#    - $HOME/.composer/cache/files
    - $HOME/.npm 

# Install a Second Programming Language (Node, to run Gulp tasks)
# We need to specify a newer version than the Travis default
# in order to avoid the build error "Use of const in strict mode"
# https://docs.travis-ci.com/user/customizing-the-build/#Installing-a-Second-Programming-language
# https://stackoverflow.com/a/44250453/6850747
before_install:
  - nvm install 6.11.2
  # Disable XDebug which is only required for Code Coverage reports
  # https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
  - phpenv config-rm xdebug.ini

# Install dependencies
# https://docs.travis-ci.com/user/customizing-the-build/#Customizing-the-Installation-Step
# Note: Remember to run composer update on local dev to get latest updates to dependencies
install:
  - composer install --no-interaction # also run via gulpfile.js
  - npm --prefix ./vendor/dotherightthing/wpdtrt-plugin/ install ./vendor/dotherightthing/wpdtrt-plugin/
  - npm install # child plugin
  - npm install bower -g
# - bower install - run via gulpfile.js
  - npm install gulp-cli -g
  # https://www.sitepoint.com/php-continuous-integration-travis-ci/
  # https://getcomposer.org/doc/03-cli.md

# https://github.com/wp-cli/sample-plugin/blob/master/.travis.yml
before_script:
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - bash bin/install-wp-tests.sh wordpress_test root '' localhost $WP_VERSION

# Run the build script
script:
  - gulp dist --gulpfile ./vendor/dotherightthing/wpdtrt-plugin/gulpfile.js --cwd ./
  - phpunit

# Notifications of build results
# https://docs.travis-ci.com/user/notifications/
notifications:
  email: false
  slack: dotherightthing:Wu2ypwc2wIFZVqVqc2jRkbWw

# Deploy code to Github as a 'release'
# This is run after a tagged commit triggers a successful build
# release.zip is generated by gulp dist
# api_key is generated via: travis setup releases
# which requires my GH username and password
# and creates a Personal Access Token at https://github.com/settings/tokens
# named 'automatic releases for dotherightthing/wpdtrt-tourdates' 
# https://docs.travis-ci.com/user/deployment/releases/
deploy:
  provider: releases
  api_key:
    secure: x1chv7Sw39jDLjW0+qXtcLJdcg+5Q9tG197do3UEAqaE4gGEfyW6fdBhrkyHVeeD5u3W0DwxeXAr79YaLURR7gKPu6UGhD1DV8ypyE2gtZKxU1RYzdGvjxTd/IhsxxMUVOelQks9oB7sXZMbyZ0rGX7VfGnzJN6VA4MLl9rM+y/JrcogyXjNRpE0CG4RZblC7zg4vobkYVIqv8rDf00kM4hee6yqJBL9NLxuH3kIovREKkRIgJDopEf37RybZoBn5WtXkrSGFucz0gF2XrgP/9P9BObCcCBM2rAbYmyEuX12NZ+QGzEUjDFre4THe3wu/EEoSMpTAPVvMz13E+Fd8cQPGG1bB2RPhBQtpEPtXxUV0YSZeOwAufxUD1v0pnqD8i2TvqtrE2wu3/2AZoFPa5EivDGmUx2SMVMJzRGRspVgvVqyG0ws3Ks3IbPFhOA+WPyez9xWTEZo9CEi1ZFJxg+iH/9chtPUZbgBuHhNYnyv7HNZDRODo/uVMifOxP9wz9Ab7y/cZuKfdMnTjo7n5smGrqDP+/udnU4iMPioeEObX6BNIVY2A8yH8T0s2doloLafXMDYSm+GLJmHkL5tEZwTLCL3Kc9T6oEqvNz0URPjH8of685KRmcOFhblobO17xe8fXtqIoUWW2mAlZj3b+TdnPBKrnXqQ9QKitGUW20=
  file: 'release.zip'
  # prevent Travis CI from resetting the working directory
  # which deletes all changes made during the build 
  skip_cleanup: true
  on:
    repo: dotherightthing/wpdtrt-tourdates
    tags: true
    # https://stackoverflow.com/a/27775257/6850747
    all_branches: true
